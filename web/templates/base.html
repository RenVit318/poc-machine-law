<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="nl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Burger.nl</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.10/htmx.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
        <script defer
                src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js"></script>
        <style>
        /* HTMX Indicator styles - hide the indicator by default */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
            pointer-events: none; /* Prevent interaction with the indicator */
        }

        /* Show the indicator when the target element is being requested */
        .htmx-request .htmx-indicator {
            opacity: 1;
        }

        .htmx-request.htmx-indicator {
            opacity: 1;
        }

        /* Ensure dropdowns work correctly */
        [x-cloak] {
            display: none !important;
        }

        body::before {
            content: "In ontwikkeling";
            position: fixed;
            width: 180px;
            top: 30px;
            right: -50px;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
            padding: 5px 0;
            background-color: #FACC15;
            color: #000;
            transform: rotate(45deg);
            transform-origin: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            pointer-events: none;
        }

        </style>
        <script>
        // Define global functions BEFORE Alpine.js loads
        window.openWalletModal = function () {
            console.log('Global openWalletModal called');
            const modal = document.getElementById('wallet-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'block';

                // If Alpine.js is already loaded, use its API to update the component
                if (window.Alpine) {
                    setTimeout(function () {
                        const alpineComponent = Alpine.raw(modal.__x.$data);
                        if (alpineComponent && typeof alpineComponent.initializeWalletServices === 'function') {
                            alpineComponent.initializeWalletServices();
                        }
                    }, 50);
                }
            } else {
                console.error('Modal element not found!');
                // Try again after a short delay
                setTimeout(function () {
                    const retryModal = document.getElementById('wallet-modal');
                    if (retryModal) {
                        retryModal.classList.remove('hidden');
                        retryModal.style.display = 'block';
                        console.log('Modal found on retry and displayed');
                    } else {
                        console.error('Modal still not found after retry');
                    }
                }, 100);
            }
        };
        </script>
        <link rel="icon"
              type="image/png"
              href="/static/img/favicon-96x96.png"
              sizes="96x96" />
        <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg" />
        <link rel="shortcut icon" href="/static/img/favicon.ico" />
        <link rel="apple-touch-icon"
              sizes="180x180"
              href="/static/img/apple-touch-icon.png" />
        <link rel="manifest" href="/static/img/site.webmanifest" />
    </head>
    <body class="min-h-screen bg-gray-50"
          x-data="{ openWallet() { window.openWalletModal(); } }"
          x-on:open-wallet-modal.window="openWallet()">
        <!-- Header -->
        <header class="bg-linear-to-br from-blue-600 to-blue-800 text-white"
                x-data="{ mobileMenuOpen: false }">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <!-- Mobile Menu Button (Left Side) -->
                    <button class="lg:hidden focus:outline-none cursor-pointer"
                            @click="mobileMenuOpen = !mobileMenuOpen"
                            aria-label="Toon/verberg menu">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-6 w-6"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <!-- Left side with Logo and Nav -->
                    <div class="flex items-center flex-1 justify-center lg:justify-start">
                        <h1 class="text-2xl font-semibold">
                            <a href="/" class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     class="w-8 h-8 mr-3"
                                     viewBox="0 0 24 24">
                                    <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                    <path d="M12 13a3 3 0 1 0 0-6a3 3 0 0 0 0 6" />
                                    <path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9s-9-1.8-9-9s1.8-9 9-9" />
                                    <path d="M6 20.05V20a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v.05" />
                                    </g>
                                </svg>
                                Burger.nl
                            </a>
                        </h1>
                        <!-- Desktop Navigation -->
                        <nav class="hidden lg:block ml-8">
                            <ul class="flex space-x-6">
                                <li>
                                    <a href="/?bsn={{ bsn }}"
                                       class="text-white hover:text-blue-200 font-medium">Dashboard</a>
                                </li>
                                {% if chat_enabled %}
                                    <li>
                                        <a href="/chat?bsn={{ bsn }}"
                                           class="text-white hover:text-blue-200 font-medium flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-5 w-5 mr-1"
                                                 fill="none"
                                                 viewBox="0 0 24 24"
                                                 stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                            </svg>
                                            Chat
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    <!-- Right side: Desktop Profile & More menu -->
                    <div class="hidden lg:flex items-center space-x-2">
                        <!-- Desktop User Switcher -->
                        <div class="relative"
                             x-data="{ profileSelectorOpen: false, selectedProfile: '{{ bsn }}' }">
                            <!-- DigiD Indicator with integrated logo -->
                            <div class="flex items-center space-x-2 bg-white text-gray-900 px-4 py-2 rounded w-[350px] cursor-pointer border border-gray-300 hover:border-blue-500"
                                 @click="profileSelectorOpen = !profileSelectorOpen">
                                <!-- DigiD logo -->
                                <div class="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0">
                                    <img src="/static/img/digid-logo.svg" alt="DigiD" class="w-full h-full" />
                                </div>
                                <div class="flex-grow truncate">
                                    <div class="font-semibold">
                                        {{ all_profiles[bsn].name if bsn in all_profiles else "Selecteer
                                        profiel" }}
                                    </div>
                                    <div class="text-xs text-gray-500 truncate">
                                        {{ all_profiles[bsn].description if bsn in
                                        all_profiles else "" }}
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         class="h-5 w-5 text-gray-500"
                                         viewBox="0 0 20 20"
                                         fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                            <!-- Desktop Dropdown Menu -->
                            <div x-show="profileSelectorOpen"
                                 x-cloak
                                 @click.away="profileSelectorOpen = false"
                                 class="absolute right-0 mt-2 w-[450px] bg-white rounded-md shadow-lg z-50 py-1 text-sm max-h-96 overflow-y-auto">
                                <div class="px-3 py-2 text-xs font-medium text-gray-500 border-b border-gray-200">
                                    Gesimuleerde
                                    DigiD Profielen
                                </div>
                                {% for bsn_key, profile_data in all_profiles.items() %}
                                    <a href="/?bsn={{ bsn_key }}"
                                       class="flex items-center px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 {% if bsn == bsn_key %}bg-blue-50{% endif %}">
                                        <div class="flex-shrink-0">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-8 w-8 text-gray-400"
                                                 viewBox="0 0 24 24"
                                                 fill="currentColor">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20z" />
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <div class="font-medium text-gray-900">{{ profile_data.name }}</div>
                                            <div class="text-sm text-gray-500">{{ profile_data.description }}</div>
                                            {% if profile_data.get('properties') %}
                                                <div class="flex flex-wrap gap-1 mt-1">
                                                    {% for property in profile_data.properties %}
                                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                            {{ property }}
                                                        </span>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            {% if profile_data.get('details') %}
                                                <div class="text-xs text-gray-400 mt-1">{{ profile_data.details }}</div>
                                            {% endif %}
                                        </div>
                                        {% if bsn == bsn_key %}
                                            <div class="ml-auto">
                                                <svg class="h-5 w-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </div>
                                        {% endif %}
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                        <!-- Desktop Kebab Menu (vertical ellipsis) -->
                        <!-- Dropdown Menu Wrapper for Homepage -->
                        <div class="homepage-dropdown-override">{% include "admin/partials/navigation_menu.html" %}</div>
                        <!-- Additional styles for homepage dropdown -->
                        <style>
                            .homepage-dropdown-override button {
                                background-color: transparent;
                            }
                            .homepage-dropdown-override button svg {
                                color: white;
                            }
                            .homepage-dropdown-override button:hover {
                                background-color: rgba(30, 64, 175, 0.8); /* blue-800 with transparency */
                            }
                        </style>
                    </div>
                    <!-- Mobile Navigation Menu -->
                    <div class="hidden">
                        <button @click="desktopMoreMenuOpen = !desktopMoreMenuOpen"
                                class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-blue-800 focus:outline-none cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="h-5 w-5 text-white"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                        </button>
                    </div>
                    <div x-show="mobileMenuOpen"
                         x-cloak
                         class="lg:hidden absolute left-0 right-0 top-16 bg-blue-900 z-50 px-4 py-4 shadow-lg overflow-y-auto max-h-[80vh]">
                        <nav>
                            <ul class="space-y-4">
                                <li>
                                    <a href="/?bsn={{ bsn }}"
                                       class="block text-white hover:text-blue-200 font-medium py-2">Dashboard</a>
                                </li>
                                {% if chat_enabled %}
                                    <li>
                                        <a href="/chat?bsn={{ bsn }}"
                                           class="block text-white hover:text-blue-200 font-medium py-2 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-5 w-5 mr-1"
                                                 fill="none"
                                                 viewBox="0 0 24 24"
                                                 stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                            </svg>
                                            Chat
                                        </a>
                                    </li>
                                {% endif %}
                                <!-- More Menu for Mobile (Kebab Menu) -->
                                <li class="pt-4 border-t border-blue-800"
                                    x-data="{ mobilemoreMenuOpen: false }">
                                    <button @click="mobilemoreMenuOpen = !mobilemoreMenuOpen"
                                            class="w-full text-white hover:text-blue-200 font-medium py-2 flex items-center justify-between cursor-pointer">
                                        <div class="flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-5 w-5 mr-1"
                                                 fill="none"
                                                 viewBox="0 0 24 24"
                                                 stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                            </svg>
                                            Meer opties
                                        </div>
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                             class="h-5 w-5"
                                             viewBox="0 0 20 20"
                                             fill="currentColor"
                                             :class="{ 'transform rotate-180': mobilemoreMenuOpen }">
                                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <!-- Mobile More Dropdown Menu -->
                                    <div x-show="mobilemoreMenuOpen" x-cloak class="bg-blue-800">
                                        <a href="/"
                                           class="block text-white hover:text-blue-200 font-medium py-2 pl-8 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-5 w-5 mr-1"
                                                 fill="none"
                                                 viewBox="0 0 24 24"
                                                 stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                                            </svg>
                                            Homepage
                                        </a>
                                        <a href="/admin"
                                           class="block text-white hover:text-blue-200 font-medium py-2 pl-8 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-5 w-5 mr-1"
                                                 fill="none"
                                                 viewBox="0 0 24 24"
                                                 stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                            </svg>
                                            Zaaksysteem
                                        </a>
                                        <a href="/admin/control"
                                           class="block text-white hover:text-blue-200 font-medium py-2 pl-8 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-5 w-5 mr-1"
                                                 fill="none"
                                                 viewBox="0 0 24 24"
                                                 stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                            Admin beheer
                                        </a>
                                        <a href="/analysis/graph"
                                           class="block text-white hover:text-blue-200 font-medium py-2 pl-8 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-5 w-5 mr-1"
                                                 fill="none"
                                                 viewBox="0 0 24 24"
                                                 stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                            </svg>
                                            Graaf analyse
                                        </a>
                                        <a href="/importer"
                                           class="block text-white hover:text-blue-200 font-medium py-2 pl-8 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-5 w-5 mr-1"
                                                 viewBox="0 0 24 24">
                                                <path fill="currentColor" fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v.756a49 49 0 0 1 9.152 1a.75.75 0 0 1-.152 1.485h-1.918l2.474 10.124a.75.75 0 0 1-.375.84A6.7 6.7 0 0 1 18.75 18a6.7 6.7 0 0 1-3.181-.795a.75.75 0 0 1-.375-.84l2.474-10.124H12.75v13.28c1.293.076 2.534.343 3.697.776a.75.75 0 0 1-.262 1.453h-8.37a.75.75 0 0 1-.262-1.453c1.162-.433 2.404-.7 3.697-.775V6.24H6.332l2.474 10.124a.75.75 0 0 1-.375.84A6.7 6.7 0 0 1 5.25 18a6.7 6.7 0 0 1-3.181-.795a.75.75 0 0 1-.375-.84L4.168 6.241H2.25a.75.75 0 0 1-.152-1.485a49 49 0 0 1 9.152-1V3a.75.75 0 0 1 .75-.75m4.878 13.543l1.872-7.662l1.872 7.662zm-9.756 0L5.25 8.131l-1.872 7.662z" clip-rule="evenodd" />
                                            </svg>
                                            Wet-importer
                                        </a>
                                    </div>
                                </li>
                                <!-- Mobile Profile Switcher Header -->
                                <li class="pt-4 border-t border-blue-800">
                                    <div class="flex items-center text-xs font-medium text-blue-300 uppercase py-2">Profiel Wisselen</div>
                                    <div x-data="{ mobileProfilesOpen: false }" class="relative">
                                        <button @click="mobileProfilesOpen = !mobileProfilesOpen"
                                                class="w-full flex items-center justify-between bg-blue-700 hover:bg-blue-600 text-white px-3 py-2 rounded cursor-pointer">
                                            <div class="flex items-center">
                                                <div class="w-6 h-6 mr-2 rounded-md overflow-hidden">
                                                    <img src="/static/img/digid-logo.svg" alt="DigiD" class="w-full h-full" />
                                                </div>
                                                {{ all_profiles[bsn].name if bsn in all_profiles else "Selecteer profiel" }}
                                            </div>
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 class="h-5 w-5"
                                                 viewBox="0 0 20 20"
                                                 fill="currentColor">
                                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                        <!-- Mobile Profile Dropdown -->
                                        <div x-show="mobileProfilesOpen"
                                             x-cloak
                                             class="bg-white rounded-md shadow-lg mt-1 py-1 text-sm max-h-96 overflow-y-auto">
                                            <div class="px-3 py-2 text-xs font-medium text-gray-500 border-b border-gray-200">Gesimuleerde DigiD Profielen</div>
                                            {% for bsn_key, profile_data in all_profiles.items() %}
                                                <a href="/?bsn={{ bsn_key }}"
                                                   class="flex items-center px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 {% if bsn == bsn_key %}bg-blue-50{% endif %}">
                                                    <div class="flex-shrink-0">
                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                             class="h-8 w-8 text-gray-400"
                                                             viewBox="0 0 24 24"
                                                             fill="currentColor">
                                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20z" />
                                                        </svg>
                                                    </div>
                                                    <div class="ml-3">
                                                        <div class="font-medium text-gray-900">{{ profile_data.name }}</div>
                                                        <div class="text-sm text-gray-500">{{ profile_data.description }}</div>
                                                        {% if profile_data.get('properties') %}
                                                            <div class="flex flex-wrap gap-1 mt-1">
                                                                {% for property in profile_data.properties %}
                                                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                                        {{ property }}
                                                                    </span>
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    {% if bsn == bsn_key %}
                                                        <div class="ml-auto">
                                                            <svg class="h-5 w-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                            </svg>
                                                        </div>
                                                    {% endif %}
                                                </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </header>
        <main class="container mx-auto px-4 py-8">
            <div id="dashboard-content" class="relative">
                {% block content %}{% endblock %}
            </div>
        </main>
        <!-- Shared Application Panel -->
        <div id="shared-application-panel"></div>
        <!-- Include wallet modal from separate template if enabled -->
        {% if wallet_enabled %}
            {% include "partials/wallet_modal.html" %}
        {% endif %}
        <script>
    // Global ESC key handler for closing the panel
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            document.dispatchEvent(new CustomEvent('close-panel'));
        }
    });

    // Set up event delegated handler for dynamically added wallet buttons
    document.body.addEventListener('click', function (e) {
        if (e.target.closest('.open-wallet-btn')) {
            e.preventDefault();

            {% if wallet_enabled %}
            window.openWalletModal();
            {% else %}
            // Show a message explaining the wallet is disabled
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow-md z-50';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="h-6 w-6 text-yellow-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>Wallet functionaliteit is momenteel uitgeschakeld</p>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
            {% endif %}
        }
    });

    // Event listener for wallet data received
    document.addEventListener('wallet-data-received', function (event) {
        console.log('ðŸ“ Wallet data received event, populating form:', event.detail);

        // Extract data from the event
        const {bsn, service, law, profile} = event.detail;

        if (!profile) {
            console.error('No wallet data profile received');
            return;
        }

        // Store the wallet data in sessionStorage for later use, keyed by BSN
        try {
            const storageKey = `walletData-${bsn}`;
            sessionStorage.setItem(storageKey, JSON.stringify(profile));
            console.log(`ðŸ’¾ Saved wallet data to sessionStorage with key ${storageKey} for future forms`);
        } catch (e) {
            console.error('Could not save wallet data to sessionStorage:', e);
        }

        // Call the function to fill the current form
        fillFormWithWalletData(profile);
    });

    // Function to fill form fields with wallet data
    function fillFormWithWalletData(profile) {
        // Find the application form on the page
        let targetForm = document.querySelector('form.application-form, form#application-form');

        // If no specific application form found, look for any form
        if (!targetForm) {
            const forms = document.querySelectorAll('form');
            if (forms.length > 0) {
                targetForm = forms[0]; // Use the first form if available
                console.log('Using first form found on the page');
            }
        }

        if (!targetForm) {
            console.error('No form found to populate with wallet data');
            return;
        }

        console.log('ðŸ” Found form to populate:', targetForm);

        // Add some CSS for wallet-filled fields
        if (!document.getElementById('wallet-fields-style')) {
            const style = document.createElement('style');
            style.id = 'wallet-fields-style';
            style.textContent = `
            .wallet-filled-field {
                background-color: rgba(219, 234, 254, 0.5) !important; /* Light blue background */
                border-color: rgb(59, 130, 246) !important; /* Blue border */
                padding-right: 35px !important; /* Make room for the icon */
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233B82F6' width='24' height='24'%3E%3Cpath d='M22 9h-2V7c0-1.7-1.3-3-3-3H7c-1.7 0-3 1.3-3 3v7c0 1.7 1.3 3 3 3h7v-2c0-1.7 1.3-3 3-3h5c1.7 0 3 1.3 3 3v3h-3c-.6 0-1 .4-1 1s.4 1 1 1h3c1.7 0 3-1.3 3-3v-5c0-1.7-1.3-3-3-3zm-7 0H7V7h8v2zm2 8c-.6 0-1-.4-1-1s.4-1 1-1 1 .4 1 1-.4 1-1 1z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 8px center;
                background-size: 20px 20px;
            }

            .wallet-filled-field:disabled {
                opacity: 1 !important; /* Keep the field looking active even when disabled */
                color: #000 !important; /* Keep text readable */
                cursor: not-allowed !important;
            }

            .wallet-filled-field:hover {
                cursor: not-allowed !important;
            }

            /* Tooltip to show on hover */
            .wallet-filled-field-container {
                position: relative;
            }

            .wallet-filled-field-container::after {
                content: "Vanuit NL Wallet gevuld";
                position: absolute;
                background-color: #3B82F6;
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                white-space: nowrap;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.2s, visibility 0.2s;
                z-index: 50;
            }

            .wallet-filled-field-container:hover::after {
                opacity: 1;
                visibility: visible;
            }
        `;
            document.head.appendChild(style);
        }

        // Helper function to mark a field as wallet-filled
        const markFieldAsWalletFilled = (field) => {
            // Add class for styling
            field.classList.add('wallet-filled-field');

            // Make field read-only or disabled
            if (field.tagName === 'SELECT') {
                field.disabled = true;
            } else {
                field.readOnly = true;
                field.setAttribute('aria-readonly', 'true');
            }

            // Add container for tooltip if not already wrapped
            if (!field.parentElement.classList.contains('wallet-filled-field-container')) {
                const parent = field.parentElement;
                const wrapper = document.createElement('div');
                wrapper.className = 'wallet-filled-field-container';
                parent.insertBefore(wrapper, field);
                wrapper.appendChild(field);
            }
        };

        // Function to convert cents to euros for display
        const centsToEuros = (cents) => {
            return (parseFloat(cents) / 100).toFixed(2);
        };

        // Track number of fields filled
        let filledCount = 0;

        // Flatten the nested data structure to make it easier to match fields
        const flattenedData = {};

        // Function to recursively flatten a nested object
        const flattenObject = (obj, prefix = '') => {
            if (!obj || typeof obj !== 'object') return;

            Object.entries(obj).forEach(([key, value]) => {
                const newKey = prefix ? `${prefix}.${key}` : key;

                if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
                    flattenObject(value, newKey); // Recursively flatten nested objects
                } else {
                    flattenedData[key] = value; // Store using just the key name (no prefix)
                    if (prefix) {
                        flattenedData[newKey] = value; // Also store with full path
                    }
                }
            });
        };

        // Start by flattening the profile object
        console.log('Processing wallet data:', profile);
        flattenObject(profile);

        // Also check for data property which might contain the actual data
        if (profile.data) {
            flattenObject(profile.data);
        }

        console.log('Flattened wallet data:', flattenedData);

        // Find and fill all value/display field pairs
        const valueFields = targetForm.querySelectorAll('[id^="value-"]');
        valueFields.forEach(valueField => {
            // Extract the field name from the ID
            const fieldName = valueField.id.substring(6); // Remove "value-" prefix

            // Look for matching data in our flattened structure
            if (flattenedData[fieldName] !== undefined) {
                // Update the value field
                valueField.value = flattenedData[fieldName];

                // Find and update the corresponding display field
                const displayField = document.getElementById(`display-${fieldName}`);
                if (displayField) {
                    // Check if this is a monetary value that should be converted to euros
                    const isMonetaryField =
                        fieldName.includes('AMOUNT') ||
                        fieldName.includes('COST') ||
                        fieldName.includes('PRICE') ||
                        fieldName.includes('EURO') ||
                        fieldName.includes('PREMIE');

                    if (isMonetaryField && typeof flattenedData[fieldName] === 'number') {
                        // Convert cents to euros
                        displayField.value = centsToEuros(flattenedData[fieldName]);
                    } else {
                        displayField.value = flattenedData[fieldName];
                    }

                    // Mark the display field as wallet-filled (the visible one)
                    markFieldAsWalletFilled(displayField);

                    // Trigger change events
                    displayField.dispatchEvent(new Event('change', {bubbles: true}));
                    displayField.dispatchEvent(new Event('input', {bubbles: true}));
                }

                // Trigger change events on the hidden value field
                valueField.dispatchEvent(new Event('change', {bubbles: true}));
                valueField.dispatchEvent(new Event('input', {bubbles: true}));

                filledCount++;
            }
        });

        // Also fill any regular fields that match data keys
        const allInputs = targetForm.querySelectorAll('input:not([id^="value-"]):not([id^="display-"])');
        allInputs.forEach(input => {
            if (!input.id && !input.name) return; // Skip inputs without identifiers

            // Try to match by id or name
            const fieldName = input.id || input.name;

            if (flattenedData[fieldName] !== undefined) {
                input.value = flattenedData[fieldName];

                // Mark the field as wallet-filled
                markFieldAsWalletFilled(input);

                input.dispatchEvent(new Event('change', {bubbles: true}));
                input.dispatchEvent(new Event('input', {bubbles: true}));

                filledCount++;
            }
        });

        console.log(`ðŸŽ‰ Auto-filled ${filledCount} form fields from wallet data`);

        // Show success notification
        if (filledCount > 0) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-md z-50';
            notification.innerHTML = `
<div class="flex items-center">
  <svg class="h-6 w-6 text-green-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
  </svg>
  <p>Formulier ingevuld met ${filledCount} velden uit NL Wallet</p>
</div>
`;

            document.body.appendChild(notification);

            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        return filledCount;
    }

    // Add MutationObserver and page load handlers to auto-fill forms
    document.addEventListener('DOMContentLoaded', function () {
        // Try to fill forms on page load if wallet data exists for current BSN
        try {
            const currentBsn = '{{ bsn }}';
            const storageKey = `walletData-${currentBsn}`;
            const savedData = sessionStorage.getItem(storageKey);
            if (savedData) {
                const walletData = JSON.parse(savedData);
                console.log(`ðŸ’¾ Found saved wallet data for BSN ${currentBsn}, attempting to fill form on page load`);
                fillFormWithWalletData(walletData);
            }
        } catch (e) {
            console.error('Error retrieving wallet data from sessionStorage:', e);
        }

        // Set up observers for HTMX events and DOM mutations

        // Listen for HTMX after-swap events (when HTMX updates the DOM)
        document.body.addEventListener('htmx:afterSwap', function (e) {
            console.log('ðŸ”„ HTMX content swapped, checking for forms to fill');
            try {
                const currentBsn = '{{ bsn }}';
                const storageKey = `walletData-${currentBsn}`;
                const savedData = sessionStorage.getItem(storageKey);
                if (savedData) {
                    setTimeout(() => {
                        const walletData = JSON.parse(savedData);
                        fillFormWithWalletData(walletData);
                    }, 100); // Short delay to ensure DOM is fully updated
                }
            } catch (e) {
                console.error('Error retrieving wallet data for HTMX swap:', e);
            }
        });

        // Set up a MutationObserver to watch for new forms being added to the DOM
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    // Check if any of the added nodes are forms or contain forms
                    const hasNewForms = Array.from(mutation.addedNodes).some(node => {
                        if (node.nodeType !== Node.ELEMENT_NODE) return false;

                        // Check if the node is a form or contains forms
                        return node.tagName === 'FORM' || node.querySelector('form');
                    });

                    if (hasNewForms) {
                        console.log('ðŸ” New form detected in DOM, attempting to fill it');
                        try {
                            const currentBsn = '{{ bsn }}';
                            const storageKey = `walletData-${currentBsn}`;
                            const savedData = sessionStorage.getItem(storageKey);
                            if (savedData) {
                                setTimeout(() => {
                                    const walletData = JSON.parse(savedData);
                                    fillFormWithWalletData(walletData);
                                }, 100); // Short delay to ensure DOM is fully updated
                            }
                        } catch (e) {
                            console.error('Error retrieving wallet data for new form:', e);
                        }
                    }
                }
            });
        });

        // Start observing changes to the body and its descendants
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        console.log('ðŸ‘€ Form observer set up to auto-fill new forms with wallet data');
    });
        </script>
        <!-- Footer -->
        <footer class="bg-gray-100 border-t mt-12">
            <div class="container mx-auto px-4 py-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-4">Demo Implementatie</h4>
                        <p class="text-gray-600">Deze demo laat zien hoe wetten als code werken</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-4">Brongegevens</h4>
                        <p class="text-gray-600">Gegevens in deze demo zijn fictief</p>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200 text-center text-gray-500 text-xs">
                    Â© 2025 Burger.nl demo | <span class="cursor-pointer hover:underline">v1.0.0</span>
                </div>
            </div>
        </footer>
    </body>
</html>
